<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>School Meet Manager — iPad (Offline)</title>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="default"/>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;School Meet Manager&quot;,&quot;short_name&quot;:&quot;Meet Manager&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%23111111&quot;,&quot;theme_color&quot;:&quot;%23111111&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;icon-192.png&quot;,&quot;sizes&quot;:&quot;192x192&quot;,&quot;type&quot;:&quot;image/png&quot;},{&quot;src&quot;:&quot;icon-512.png&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/png&quot;}]}"/>
<style>
:root { --pad: 14px; --bg: #f7f7fb; --card: #fff; --muted:#6b7280; --b:#e5e7eb; }
*{ box-sizing: border-box; }
body{ margin:0; font:16px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#111;}
header{ padding:var(--pad); background:#111; color:#fff; }
header h1{ margin:0 0 4px; font-size:20px; }
header .sub{ color:#cbd5e1; font-size:13px; }
nav.tabs{ display:flex; gap:6px; padding:6px var(--pad); background:#fff; border-bottom:1px solid var(--b);}
nav.tabs button{ flex:1; padding:12px; border:1px solid var(--b); background:#fff; border-radius:8px; font-weight:600;}
nav.tabs button.active{ background:#111; color:#fff; }
section.tab{ display:none; padding:var(--pad); }
section.tab.active{ display:block; }
h2{ margin:0 0 10px; font-size:18px; }
h3{ margin:16px 0 8px; font-size:16px; }
.row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px;}
.grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; align-items:end; }
label{ display:flex; flex-direction:column; gap:6px; font-size:14px;}
input, select, textarea, button{ font:inherit; }
input, select, textarea{ padding:10px; border:1px solid var(--b); border-radius:8px; background:#fff; }
textarea{ width:100%; }
button{ padding:12px 14px; border:1px solid var(--b); border-radius:10px; background:#111; color:#fff; }
button.secondary{ background:#fff; color:#111; }
button:active{ transform:scale(0.99); }
.hint{ color:var(--muted); font-size:13px; }
.preview{ margin-top:10px; padding:10px; background:#fff; border:1px solid var(--b); border-radius:8px;}
table.listing{ width:100%; border-collapse:collapse; background:#fff; border:1px solid var(--b); border-radius:8px; overflow:hidden; }
table.listing th, table.listing td{ padding:10px; border-bottom:1px solid var(--b); text-align:left; }
table.listing th{ background:#f3f4f6; }
.badge{ margin-left:6px; font-size:11px; background:#eef2ff; color:#3730a3; padding:2px 6px; border-radius:999px; border:1px solid #c7d2fe; }
footer{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:var(--pad); border-top:1px solid var(--b); background:#fff; position:sticky; bottom:0;}
code{ background:#111; color:#fff; padding:2px 6px; border-radius:6px; font-size:13px;}
.warn{ outline:2px solid #f59e0b; background:#fff7ed; }
#valMsg{ display:none; margin:10px 0; padding:10px; border-radius:8px; background:#fef3c7; color:#92400e; white-space:pre-line; }
.small{ font-size:12px; color:#6b7280; }
.table-sm td, .table-sm th{ padding:6px 8px; }
#ageDefImportStatus{ margin-top:8px; font-size:13px; color:#374151;}
.inline-controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
.inline-controls label{ flex-direction:row; align-items:center; gap:8px; margin:0; }
.inline-controls input[type=checkbox]{ margin:0; }
</style>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
<header>
  <h1>School Meet Manager</h1>
  <div class="sub">iPad (offline) • 10-7-5-3-2-1 scoring • lane-free</div>
</header>

<div id="storageAlert" style="display:none;padding:10px;background:#fee2e2;color:#991b1b">
  Storage is unavailable (Private Browsing or blocked). Turn off Private Browsing and reload.
</div>
<div id="importMsg" style="display:none;margin:10px 14px;padding:10px;border-radius:8px;background:#fef3c7;color:#92400e;white-space:pre-line"></div>

<nav class="tabs">
  <button data-tab="data" class="active">Data</button>
  <button data-tab="events">Events</button>
  <button data-tab="results">Results</button>
  <button data-tab="reports">Reports</button>
  <button data-tab="settings">Settings</button>
</nav>

<section id="tab-data" class="tab active">
  <h2>Participants</h2>
  <p>Paste CSV: <code>First,Last,Gender,AgeGroup,Team</code></p>
  <textarea id="csvAth" rows="6" placeholder="First,Last,Gender,AgeGroup,Team&#10;Alex,Smith,Girls,U13,Fraser"></textarea>
  <div class="row">
    <button id="btnImportAth">Import Athletes</button>
    <button id="btnSampleCsv" class="secondary">Insert Sample CSV</button>
    <button id="btnSeedDemo">Seed Demo Data</button>
    <span class="hint">Demo: U13 Girls, 100m + Long Jump with results.</span>
  </div>

  <h3>Quick Add Event</h3>
  <div class="grid">
    <label>Name <input id="evName" placeholder="100m Final"/></label>
    <label>Type
      <select id="evType"><option value="track_time">Track (time)</option><option value="field_distance">Field (distance)</option></select>
    </label>
    <label>Gender
      <select id="evGender"><option>Girls</option><option>Boys</option></select>
    </label>
    <label>Age Group <input id="evAge" placeholder="U13"/></label>
    <button id="btnAddEvent">Add Event</button>
  </div>

  <h3>Standard Event Set (wizard)</h3>
  <div class="grid">
    <label>Age Group <input id="wizAge" placeholder="U13"/></label>
    <label>Gender
      <select id="wizGender"><option>Girls</option><option>Boys</option></select>
    </label>
    <label><input type="checkbox" id="wizAuto" checked/> Auto-enrol all athletes</label>
    <button id="btnEventWizard">Create standard event set</button>
  </div>

  <h3>Bulk Create Event Sets (all ages/genders)</h3>
  <div class="grid">
    <label>Age groups (comma / space / new lines)
      <textarea id="bulkAges" rows="3" placeholder="U9 U10 U11 U12 U13 U14"></textarea>
    </label>
    <label><input type="checkbox" id="bulkGirls" checked/> Girls</label>
    <label><input type="checkbox" id="bulkBoys" checked/> Boys</label>
    <label><input type="checkbox" id="bulkAuto" checked/> Auto-enrol athletes</label>
    <button id="btnBulkWizard">Create event sets for all</button>
  </div>

  <h3>Auto-create Entries</h3>
  <p>Put whole participant list into every event for that age group.</p>
  <div class="grid">
    <label>Age Group <input id="autoAge" placeholder="U13"/></label>
    <label>Gender <select id="autoGender"><option>Girls</option><option>Boys</option></select></label>
    <button id="btnAutoEntries">Add All Athletes to All Events</button>
  </div>

  <h3>Current Athletes</h3>
  <table id="tblAthletes" class="listing"></table>
</section>

<section id="tab-events" class="tab">
  <h2>Events</h2>
  <div class="row">
    <label>Filter Age <input id="fAgeEv" placeholder="U13"/></label>
    <label>Gender <select id="fGenderEv"><option value="">All</option><option>Girls</option><option>Boys</option></select></label>
    <label><input type="checkbox" id="filterCustomOnly"/> Show only custom validation</label>
    <button id="btnFilterEv">Filter</button>
  </div>
  <table id="tblEvents" class="listing"></table>

  <h3>Advancement / Qualification</h3>
  <div class="grid">
    <label>Event <select id="advEvent"></select></label>
    <label>Qualify mode
      <select id="qualMode"><option value="disabled">Disabled</option><option value="top_n">Top N</option><option value="standard">Standard</option></select>
    </label>
    <label>Top N <input id="qualTopN" type="number" min="1"/></label>
    <label>Standard (time or distance) <input id="qualStd" placeholder="12.50 or 4.50"/></label>
    <label>Cap (optional) <input id="qualCap" type="number" min="1"/></label>
    <label>Cap policy <select id="capPolicy"><option value="include_ties">Include ties</option><option value="drop_ties">Drop ties</option></select></label>
    <label>Advance mode <select id="advMode"><option value="place">By place</option><option value="time">By time</option></select></label>
    <label>Advance N <input id="advN" type="number" min="1"/></label>
    <button id="btnSaveAdv">Save</button>
  </div>

  <h3>Per-Event Validation Ranges</h3>
  <div class="grid">
    <label>Event <select id="valEvent"></select></label>
    <label>Min Time (s) <input id="valMinTime" type="number" step="0.01" placeholder="default 5.00"/></label>
    <label>Max Time (s) <input id="valMaxTime" type="number" step="0.01" placeholder="default 600.00"/></label>
    <label>Min Distance (m) <input id="valMinDist" type="number" step="0.01" placeholder="default 0.50"/></label>
    <label>Max Distance (m) <input id="valMaxDist" type="number" step="0.01" placeholder="default 20.00"/></label>
    <label>Preset
      <select id="valPreset">
        <option value="">— choose preset —</option>
        <optgroup label="Track (time)">
          <option value="sprint">Sprints (8–90s)</option>
          <option value="middle">Middle distance (90–600s)</option>
          <option value="long">Long distance (120–1200s)</option>
        </optgroup>
        <optgroup label="Field (distance)">
          <option value="lj">Long/Triple Jump (1.50–8.50m)</option>
          <option value="hj">High Jump (0.50–2.50m)</option>
          <option value="shot">Shot Put (2–20m)</option>
          <option value="disc_jav">Discus/Javelin (5–60m)</option>
        </optgroup>
      </select>
    </label>
    <button id="btnApplyPreset" class="secondary">Apply preset</button>
    <button id="btnSaveVal">Save Validation</button>
    <button id="btnResetVal" class="secondary">Reset to defaults</button>
  </div>

  <h3>Duplicate Event</h3>
  <div class="grid">
    <label>Source event <select id="dupSource"></select></label>
    <label>New name <input id="dupName" placeholder="e.g. 100m Final"/></label>
    <label>Target Age <input id="dupAge" placeholder="U13"/></label>
    <label>Target Gender
      <select id="dupGender"><option>Girls</option><option>Boys</option></select>
    </label>
    <label><input type="checkbox" id="dupCopyAdv" checked/> Copy advancement settings</label>
    <label><input type="checkbox" id="dupAutoEntries" checked/> Auto-add all athletes</label>
    <label>Copy validation from (optional) <select id="dupValFrom"><option value="">— none —</option></select></label>
    <button id="btnDuplicateEvent">Duplicate</button>
  </div>
</section>

<section id="tab-results" class="tab">
  <h2>Enter Results</h2>
  <div class="row">
    <label>Event <select id="resEvent"></select></label>
    <button id="btnLoadEntries">Load Entries</button>
  </div>
  <div id="valMsg"></div>
  <div id="entriesWrap"></div>
  <div class="row">
    <button id="btnSaveResults">Save Results</button>
    <button id="btnClearResults">Clear Results</button>
  </div>
</section>

<section id="tab-reports" class="tab">
  <h2>Reports & Exports</h2>
  <div class="grid">
    <label>Age Group <input id="repAge" placeholder="U13"/></label>
    <label>Gender <select id="repGender"><option>Girls</option><option>Boys</option></select></label>
  </div>

  <h3>PDF (A4)</h3>
  <div class="row">
    <button id="pdfEvent">Per-Event Results PDF</button>
    <button id="pdfEventSummary">Per-Event Summary PDF</button>
    <button id="pdfFinalMarshal">Final Marshalling PDF (selected event)</button>
  </div>
  <div class="row">
    <button id="pdfAgeGroup">Age-Group Meet Report</button>
    <button id="pdfHouseTotals">House Totals PDF</button>
    <button id="pdfAllSummaries">All Event Summaries (Age+Gender)</button>
    <button id="pdfAllMarshalling">All Finals Marshalling (Age+Gender)</button>
  </div>

  <h3>CSV</h3>
  <div class="grid">
    <label>Event <select id="csvEvent"></select></label>
    <label><input type="checkbox" id="csvExcludeZero"/> Breakdown: hide zero-point rows</label>
  </div>
  <div class="row">
    <button id="csvPlacings">Placings CSV</button>
    <button id="csvScorers">Point Scorers CSV</button>
    <button id="csvStandings">Standings CSV (Age+Gender)</button>
    <button id="csvHouse">House Totals CSV (Age+Gender)</button>
    <button id="csvBreakdown">Age Champion Breakdown CSV</button>
  </div>
</section>

<section id="tab-settings" class="tab">
  <h2>Settings</h2>
  <div class="grid">
    <label>Default DRAFT watermark <input id="setDraft" type="checkbox"/></label>
    <label>Hide “Scoring key” on PDFs <input id="setHideKey" type="checkbox"/></label>
    <label>CSV header template <input id="setCsvTpl" placeholder="{STATE} generated {TIMESTAMP}"/></label>
  </div>
  <div class="preview">
    <div>CSV header preview:</div>
    <code id="csvHeaderPreview"></code>
  </div>

  <h3>Per-age validation defaults</h3>
  <div class="grid">
    <label>Age Group <input id="ageDefAge" placeholder="U13"/></label>
    <label>Track preset
      <select id="ageDefTrackPreset">
        <option value="">— none —</option>
        <option value="sprint">Sprints (8–90s)</option>
        <option value="middle">Middle distance (90–600s)</option>
        <option value="long">Long distance (120–1200s)</option>
      </select>
    </label>
    <label>Field preset
      <select id="ageDefFieldPreset">
        <option value="">— none —</option>
        <option value="lj">Long/Triple Jump (1.50–8.50m)</option>
        <option value="hj">High Jump (0.50–2.50m)</option>
        <option value="shot">Shot Put (2–20m)</option>
        <option value="disc_jav">Discus/Javelin (5–60m)</option>
      </select>
    </label>
    <button id="btnSaveAgeDef">Save defaults</button>
    <button id="btnClearAgeDef" class="secondary">Clear defaults for age</button>
  </div>
  <div class="row inline-controls">
    <label>Apply defaults to events for age <input id="applyAgeFor" placeholder="U13"/></label>
    <button id="btnApplyAgeDefaultsToEvents">Apply to all events for this age</button>
    <button id="btnApplyAllAgeDefaultsToEvents" class="secondary">Apply ALL age defaults → ALL matching events</button>
    <label><input type="checkbox" id="chkPreviewApply" checked/> Preview changes first</label>
    <button id="btnUndoApply" class="secondary">Undo last apply</button>
  </div>
  <div class="small">When you create events for an age, these ranges auto-fill. You can still override per event.</div>
  <h4 style="margin-top:10px">Saved age defaults</h4>
  <table id="tblAgeDefaults" class="listing table-sm"></table>

  <h3>Import/Export age defaults</h3>
  <div class="row inline-controls">
    <button id="btnExportAgeDefaultsCsv" class="secondary">Export age defaults CSV</button>
    <button id="btnExportAgeDefaultsTemplate" class="secondary">Download CSV template</button>
    <input id="ageDefCsvFile" type="file" accept=".csv,text/csv" hidden/>
    <button id="btnImportAgeDefaultsCsv" class="secondary">Import age defaults CSV</button>
    <label><input type="checkbox" id="chkApplyAfterImport" checked/> After import: auto-apply defaults</label>
  </div>
  <div id="ageDefImportStatus" class="small"></div>

  <h3>Backup / Restore</h3>
  <div class="row">
    <button id="btnBackup" class="secondary">Download backup (JSON)</button>
    <input id="restoreFile" type="file" accept="application/json" hidden/>
    <button id="btnRestore" class="secondary">Restore from backup (replace)</button>
  </div>
  <div class="row">
    <button id="btnSaveSettings">Save Settings</button>
    <button id="btnResetOutput">Reset Output Defaults</button>
    <button id="btnClearAll" class="secondary">Clear all data (reset)</button>
    <span class="hint">Use <code>{STATE}</code> and <code>{TIMESTAMP}</code>.</span>
  </div>
</section>

<footer>
  <button id="btnInstall" hidden>Install App</button>
  <span>Offline ready • Data stored on this device</span>
</footer>

<script>
/* service worker */
if ('serviceWorker' in navigator) {
  const swBlob = new Blob([`
    const CACHE='meet-cache-v1';
    const ASSETS=['.'];
    self.addEventListener('install',e=>{e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)))});
    self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))))});
    self.addEventListener('fetch',e=>{ if(e.request.method!=='GET') return;
      e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{ if(new URL(e.request.url).origin===location.origin){const cl=resp.clone(); caches.open(CACHE).then(c=>c.put(e.request,cl));} return resp;})));
    });
  `], {type:'text/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}
</script>

<script>
const { jsPDF } = window.jspdf;

/* IDB helpers */
const DB_NAME='meet-db'; const DB_VER=1; let db;
async function idbOpen(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const d=req.result;
      if (!d.objectStoreNames.contains('athletes')) d.createObjectStore('athletes', { keyPath:'id', autoIncrement:true });
      if (!d.objectStoreNames.contains('events'))   d.createObjectStore('events',   { keyPath:'id', autoIncrement:true });
      if (!d.objectStoreNames.contains('entries'))  d.createObjectStore('entries',  { keyPath:'id' });
      if (!d.objectStoreNames.contains('results'))  d.createObjectStore('results',  { keyPath:'entry_id' });
      if (!d.objectStoreNames.contains('settings')) d.createObjectStore('settings', { keyPath:'id' });
    };
    req.onerror = () => reject(req.error || new Error('IndexedDB open error'));
    req.onsuccess = () => resolve(req.result);
  });
}
function tx(s,m='readonly'){return db.transaction(s,m).objectStore(s);}
function all(s){return new Promise((res,rej)=>{const r=tx(s).getAll(); r.onerror=()=>rej(r.error); r.onsuccess=()=>res(r.result);});}
function put(s,v){return new Promise((res,rej)=>{const r=tx(s,'readwrite').put(v); r.onerror=()=>rej(r.error); r.onsuccess=()=>res(r.result);});}
function del(s,k){return new Promise((res,rej)=>{const r=tx(s,'readwrite').delete(k); r.onerror=()=>rej(r.error); r.onsuccess=()=>res();});}

/* settings */
const defaultSettings={
  id:1,
  default_scoring:[10,7,5,3,2,1],
  tie_policy:'average_points',
  default_pdf_draft:true,
  hide_scoring_key:false,
  csv_header_template:'{STATE} generated {TIMESTAMP}',
  age_validation_defaults:{} /* { U13: { track:{min_time_ms,max_time_ms}, field:{min_dist_mm,max_dist_mm} } } */
};
async function getSettings(){
  const r=await new Promise(res=>{const q=tx('settings').get(1); q.onsuccess=()=>res(q.result||null);});
  if(!r){await put('settings',defaultSettings); return defaultSettings;}
  return {...defaultSettings,...r, age_validation_defaults: r.age_validation_defaults||{}};
}

/* parsing */
function parseTimeToMs(s){const t=(s||'').trim(); if(!t) return null; if(t.includes(':')){const [m,rest]=t.split(':'); return Math.round(parseFloat(rest)*1000)+parseInt(m,10)*60000;} return Math.round(parseFloat(t)*1000);}
function parseDistToMm(s){const t=(s||'').trim().toLowerCase().replace('m','').replace(/\s+/g,''); if(!t) return null;
  if(t.includes('.')){const [m,cm]=t.split('.',2); const meters=parseInt(m||'0',10); const centi=parseInt((cm||'').padEnd(2,'0').slice(0,2),10); return meters*1000+centi*10;}
  return Math.round(parseFloat(t)*1000);}
function msToS(ms){ return ms!=null? (ms/1000).toFixed(2) : ''; }
function mmToM(mm){ return mm!=null? (mm/1000).toFixed(2) : ''; }

/* ranking/scoring */
function eventSortKey(type, perf){ if(perf==null) return [2,Infinity]; if(type==='track_time') return [0,perf]; if(type==='field_distance') return [0,-perf]; return [1,0];}
function rankAndScore(ev, entries, results, settings){
  const scoring=(ev.scoring_table&&ev.scoring_table.length?ev.scoring_table:settings.default_scoring).slice();
  const rows=entries.map(en=>{const r=results.find(rr=>rr.entry_id===en.id)||null; return {en, perf:r?r.normalized_value:null, raw:r?r.raw_value:'', notes:r?r.notes||''};});
  rows.sort((a,b)=>{const ka=eventSortKey(ev.type,a.perf), kb=eventSortKey(ev.type,b.perf); return ka[0]-kb[0]||ka[1]-kb[1];});
  const out=[]; let i=0, place=1;
  while(i<rows.length){
    const block=[rows[i]]; let j=i+1;
    while(j<rows.length && rows[j].perf===rows[i].perf && rows[i].perf!=null){block.push(rows[j]); j++;}
    const tie=rows[i].perf==null?1:block.length; const occ=Array.from({length:tie},(_,k)=>place+k);
    const pts=occ.map(p=>(p-1)<scoring.length?scoring[p-1]:0); const avg=tie>1?pts.reduce((a,b)=>a+b,0)/tie:(pts[0]||0);
    for(const b of block){ const a = b.en; out.push({entry_id:a.id, place:b.perf==null?0:place, tie_span:tie, points:b.perf==null?0:avg, raw:b.raw||'', athlete_name:a.athlete_name, team:a.team||''});}
    place+=tie; i=j;
  }
  return out;
}

/* advancement */
function selectFinalists(ev, placings){
  if(!ev.advance_n || ev.advance_n<=0) return [];
  const includeTies = (ev.cap_policy||'include_ties')==='include_ties';
  const ranked = placings.filter(p=>p.place>0);
  if(ranked.length<=ev.advance_n) return ranked.map(p=>p.entry_id);
  const cut = ev.advance_n;
  const last = ranked[cut-1];
  if(!includeTies) return ranked.slice(0, cut).map(p=>p.entry_id);
  const placeCut = last.place;
  return ranked.filter(p=>p.place===placeCut || p.place<placeCut).map(p=>p.entry_id);
}

/* utils */
const $ = s=>document.querySelector(s);
function nowStamp(){const d=new Date(); const pad=n=>n<10?'0'+n:n; return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function drawWatermark(doc, text){doc.saveGraphicsState(); doc.setFont('helvetica','bold'); doc.setFontSize(72); doc.setTextColor(230,230,230); doc.text(text,105,150,{angle:45,align:'center'}); doc.restoreGraphicsState();}
function footer(doc,title,page){doc.setFontSize(8); doc.setTextColor(0,0,0); doc.text(`${title} · Page ${page} · Printed ${nowStamp()}`,200-10,290,{align:'right'});}
function table(doc,x,y,heads,rows){const lineH=7, cellW=(190)/heads.length; doc.setFontSize(10); doc.setFillColor(243,244,246);
  heads.forEach((h,i)=>{doc.rect(x+i*cellW,y,cellW,lineH,'F'); doc.text(String(h),x+2+i*cellW,y+5);});
  let yy=y+lineH; rows.forEach(r=>{r.forEach((c,i)=>{doc.rect(x+i*cellW,yy,cellW,lineH); doc.text(String(c??''),x+2+i*cellW,yy+5);}); yy+=lineH;}); return yy;}

/* presets */
const PRESETS={
  sprint:   { minTime: 8,   maxTime: 90,  minDist: null, maxDist: null },
  middle:   { minTime: 90,  maxTime: 600, minDist: null, maxDist: null },
  long:     { minTime: 120, maxTime: 1200,minDist: null, maxDist: null },
  lj:       { minTime: null,maxTime: null,minDist: 1.5,  maxDist: 8.5  },
  hj:       { minTime: null,maxTime: null,minDist: 0.5,  maxDist: 2.5  },
  shot:     { minTime: null,maxTime: null,minDist: 2,    maxDist: 20   },
  disc_jav: { minTime: null,maxTime: null,minDist: 5,    maxDist: 60   }
};
function applyPresetToInputs(key){
  const p=PRESETS[key]; if(!p) return;
  $('#valMinTime').value = p.minTime!=null ? p.minTime : '';
  $('#valMaxTime').value = p.maxTime!=null ? p.maxTime : '';
  $('#valMinDist').value = p.minDist!=null ? p.minDist : '';
  $('#valMaxDist').value = p.maxDist!=null ? p.maxDist : '';
}
function applyPresetToRanges(key){
  const p=PRESETS[key]; if(!p) return {};
  return {
    min_time_ms: p.minTime!=null? Math.round(p.minTime*1000): null,
    max_time_ms: p.maxTime!=null? Math.round(p.maxTime*1000): null,
    min_dist_mm: p.minDist!=null? Math.round(p.minDist*1000): null,
    max_dist_mm: p.maxDist!=null? Math.round(p.maxDist*1000): null
  };
}

/* data UI */
async function refreshAthletes(){
  const A=await all('athletes');
  $('#tblAthletes').innerHTML='<tr><th>Name</th><th>Gender</th><th>Age</th><th>Team</th></tr>'+A.map(a=>`<tr><td>${a.first} ${a.last}</td><td>${a.gender}</td><td>${a.age_group}</td><td>${a.team||''}</td></tr>`).join('');
}
function hasCustomValidation(e){ return e.val_min_time_ms!=null||e.val_max_time_ms!=null||e.val_min_dist_mm!=null||e.val_max_dist_mm!=null; }
async function refreshEventsFilters(){
  const E=await all('events'); const age=$('#fAgeEv').value.trim(); const g=$('#fGenderEv').value.trim(); const onlyCustom=$('#filterCustomOnly').checked;
  const filtered=E.filter(e=>(!age||e.age_group===age)&&(!g||e.gender===g)&&(!onlyCustom||hasCustomValidation(e)));
  $('#tblEvents').innerHTML='<tr><th>Name</th><th>Type</th><th>Age</th><th>Gender</th></tr>'+filtered.map(e=>{
    const badge = hasCustomValidation(e) ? '<span class="badge">custom validation</span>' : '';
    return `<tr><td>${e.name} ${badge}</td><td>${e.type}</td><td>${e.age_group}</td><td>${e.gender}</td></tr>`;
  }).join('');
  const mk=(arr)=>arr.map(e=>`<option value="${e.id}">${e.name} (${e.age_group} ${e.gender})</option>`).join('');
  $('#resEvent').innerHTML=mk(filtered.length?filtered:E);
  $('#advEvent').innerHTML=mk(E);
  $('#csvEvent').innerHTML=mk(E);
  $('#dupSource').innerHTML=mk(E);
  $('#dupValFrom').innerHTML='<option value="">— none —</option>'+mk(E);
  $('#valEvent').innerHTML=mk(E);
  const first=E[0]; if(first) $('#dupName').value=first.name;
}

/* entries/results UI */
async function loadEntriesForEvent(evId){
  const [E, EN, A, R] = await Promise.all([all('events'), all('entries'), all('athletes'), all('results')]);
  const ev=E.find(e=>e.id==evId);
  const evEntries=EN.filter(en=>en.event_id==evId).map(en=>{
    const a=A.find(x=>x.id===en.athlete_id); const r=R.find(rr=>rr.entry_id===en.id);
    return { id:en.id, name:`${a.first} ${a.last}`, team:a.team||'', raw:r?r.raw_value:'', wind:r?r.wind||'' };
  });
  const wrap=$('#entriesWrap');
  if(!evEntries.length){ wrap.innerHTML='<p>No entries for this event. Use “Auto-create Entries”.</p>'; return; }
  wrap.innerHTML=`<table class="listing"><tr><th>Athlete</th><th>Team</th><th>Result</th><th>Wind</th></tr>${
    evEntries.map(e=>`<tr><td>${e.name}</td><td>${e.team}</td>
      <td><input data-entry="${e.id}" class="resInput" placeholder="${ev.type==='track_time'?'12.34 or 1:02.34':'4.55'}" value="${e.raw||''}"></td>
      <td><input data-wind="${e.id}" class="windInput" placeholder="+1.2" value="${e.wind||''}"></td>
    </tr>`).join('')
  }</table>`;
}

/* placings helpers */
async function buildPlacings(eventId){
  const [S, E, EN, A, R] = await Promise.all([getSettings(), all('events'), all('entries'), all('athletes'), all('results')]);
  const ev=E.find(e=>e.id==eventId);
  const ens=EN.filter(en=>en.event_id==eventId).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return {...en, athlete_name:`${a.first} ${a.last}`, team:a.team||''};});
  return rankAndScore(ev, ens, R, S);
}
function scoringKeyMaybe(S){return S.hide_scoring_key?'':'Scoring: 10-7-5-3-2-1 (ties average points).';}
function csvHeader(S){const state=S.default_pdf_draft?'DRAFT':'FINAL'; const line=(S.csv_header_template||'{STATE} generated {TIMESTAMP}').replaceAll('{STATE}',state).replaceAll('{TIMESTAMP}',nowStamp()).replace(/\s+/g,' ').trim(); return `# ${line}`;}
function downloadText(name,text){const blob=new Blob([text],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);}

/* PDFs */
async function pdfPerEvent(full=false){
  const evId=parseInt($('#csvEvent').value,10);
  const [S, E, EN, A] = await Promise.all([getSettings(), all('events'), all('entries'), all('athletes')]);
  const ev=E.find(e=>e.id==evId); const doc=new jsPDF({unit:'mm',format:'a4'}); const title=`${ev.age_group} ${ev.gender} — ${ev.name}`; if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');
  doc.setFontSize(18); doc.text(title,10,14); doc.setFontSize(10); let y=22;
  if(full){const evEntries=EN.filter(en=>en.event_id==evId).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return [en.heat||'',`${a.first} ${a.last}`,a.team||'','',''];}); y=table(doc,10,y,['Heat','Athlete','Team','Result','Notes'],evEntries); y+=4;}
  const placings=await buildPlacings(evId);
  const rows=placings.filter(p=>p.place>0).map(p=>[(p.tie_span>1?'T':'')+p.place,'',p.athlete_name,p.team,p.raw,p.points.toFixed(2)]);
  y=table(doc,10,y,['Place','★','Athlete','Team','Result','Points'],rows); y+=4; const key=scoringKeyMaybe(S); if(key){doc.text(key,10,y); y+=6;}
  const scorers=placings.filter(p=>p.place>0&&p.points>0).map(p=>[p.athlete_name,p.team,(p.tie_span>1?'T':'')+p.place,p.points.toFixed(2),p.raw]);
  if(scorers.length){doc.setFontSize(12); doc.text('Point Scorers',10,y); y+=4; doc.setFontSize(10); y=table(doc,10,y,['Athlete','Team','Place','Points','Raw Result'],scorers);}
  footer(doc,title,1); doc.save(`${ev.age_group}_${ev.gender}_${ev.name.replaceAll(' ','_')}${full?'':'_summary'}.pdf`);
}
async function pdfAgeGroupReport(){const ag=$('#repAge').value.trim(), g=$('#repGender').value.trim(); const [S,E,EN,A]=await Promise.all([getSettings(),all('events'),all('entries'),all('athletes')]);
  const evs=E.filter(e=>e.age_group===ag&&e.gender===g).sort((a,b)=>a.name.localeCompare(b.name)); if(!evs.length) return alert('No events.');
  const doc=new jsPDF({unit:'mm',format:'a4'}); if(S.default_pdf_draft) drawWatermark(doc,'DRAFT'); let page=1;
  doc.setFontSize(20); doc.text(`${ag} ${g} — Meet Report`,10,16); doc.setFontSize(10); doc.text(nowStamp(),10,22); footer(doc,`${ag} ${g} — Meet Report`,page);
  for(let i=0;i<evs.length;i++){ if(i>0){doc.addPage(); page++; if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');}
    const e=evs[i]; let y=14; doc.setFontSize(16); doc.text(`${e.age_group} ${e.gender} — ${e.name}`,10,y); y+=6; doc.setFontSize(10);
    const evEntries=EN.filter(en=>en.event_id===e.id).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return [en.heat||'',`${a.first} ${a.last}`,a.team||'','',''];});
    y=table(doc,10,y,['Heat','Athlete','Team','Result','Notes'],evEntries); y+=4;
    const placings=await buildPlacings(e.id);
    const rows=placings.filter(p=>p.place>0).map(p=>[(p.tie_span>1?'T':'')+p.place,'',p.athlete_name,p.team,p.raw,p.points.toFixed(2)]);
    y=table(doc,10,y,['Place','★','Athlete','Team','Result','Points'],rows); y+=4; const key=scoringKeyMaybe(S); if(key){doc.text(key,10,y); y+=6;}
    const scorers=placings.filter(p=>p.place>0&&p.points>0).map(p=>[p.athlete_name,p.team,(p.tie_span>1?'T':'')+p.place,p.points.toFixed(2),p.raw]);
    if(scorers.length){doc.setFontSize(12); doc.text('Point Scorers',10,y); y+=4; doc.setFontSize(10); y=table(doc,10,y,['Athlete','Team','Place','Points','Raw Result'],scorers);}
    footer(doc,`${ag} ${g} — Meet Report`,page);
  } doc.save(`${ag}_${g}_meet_report.pdf`);}
async function pdfHouse(){const ag=$('#repAge').value.trim(), g=$('#repGender').value.trim(); const S=await getSettings(); const doc=new jsPDF({unit:'mm',format:'a4'}); if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');
  doc.setFontSize(18); doc.text(`${ag} ${g} — House Totals`,10,14); const rows=await computeHouseTotals(ag,g); table(doc,10,22,['Rank','Team/House','Total Points'],rows.map((r,i)=>[i+1,r.team,r.points.toFixed(2)]));
  footer(doc,`${ag} ${g} — House Totals`,1); doc.save(`${ag}_${g}_house_totals.pdf`);}
async function pdfAllSummaries(){const ag=$('#repAge').value.trim(), g=$('#repGender').value.trim(); const [S,E]=await Promise.all([getSettings(),all('events')]);
  const evs=E.filter(e=>e.age_group===ag&&e.gender===g).sort((a,b)=>a.name.localeCompare(b.name)); if(!evs.length) return alert('No events.'); const doc=new jsPDF({unit:'mm',format:'a4'}); if(S.default_pdf_draft) drawWatermark(doc,'DRAFT'); let page=1;
  doc.setFontSize(18); doc.text(`${ag} ${g} — Event Summaries`,10,14); footer(doc,`${ag} ${g} — Event Summaries`,page);
  for(let i=0;i<evs.length;i++){ if(i>0){doc.addPage(); page++; if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');}
    const e=evs[i]; let y=14; doc.setFontSize(14); doc.text(e.name, 10, y); y+=4; doc.setFontSize(10);
    const placings=await buildPlacings(e.id);
    const rows=placings.filter(p=>p.place>0).map(p=>[(p.tie_span>1?'T':'')+p.place,'',p.athlete_name,p.team,p.raw,p.points.toFixed(2)]);
    y=table(doc,10,y,['Place','★','Athlete','Team','Result','Points'],rows); y+=4; const key=scoringKeyMaybe(S); if(key){doc.text(key,10,y); y+=6;}
    const scorers=placings.filter(p=>p.place>0&&p.points>0).map(p=>[p.athlete_name,p.team,(p.tie_span>1?'T':'')+p.place,p.points.toFixed(2),p.raw]);
    if(scorers.length){doc.setFontSize(12); doc.text('Point Scorers',10,y); y+=4; doc.setFontSize(10); y=table(doc,10,y,['Athlete','Team','Place','Points','Raw Result'],scorers);}
    footer(doc,`${ag} ${g} — Event Summaries`,page);
  } doc.save(`${ag}_${g}_event_summaries.pdf`);}

/* marshalling */
async function pdfMarshallingForEvent(evId){
  const [S,E,EN,A,R]=await Promise.all([getSettings(),all('events'),all('entries'),all('athletes'),all('results')]);
  const ev=E.find(e=>e.id==evId); const doc=new jsPDF({unit:'mm',format:'a4'}); const title=`${ev.age_group} ${ev.gender} — ${ev.name} (Final Marshalling)`; if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');
  doc.setFontSize(18); doc.text(title,10,14);
  const ens=EN.filter(en=>en.event_id==evId).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return {...en, athlete_name:`${a.first} ${a.last}`, team:a.team||''};});
  const placings=rankAndScore(ev, ens, R, S);
  const finalistsIds=selectFinalists(ev, placings);
  if(!finalistsIds.length) { doc.setFontSize(12); doc.text('No finalists configured. Set Advance N in Events → Advancement.',10,26); footer(doc,title,1); return doc.save(`${ev.age_group}_${ev.gender}_${ev.name.replaceAll(' ','_')}_marshalling.pdf`); }
  const finalists = ens.filter(en=>finalistsIds.includes(en.id)).sort((a,b)=> a.athlete_name.localeCompare(b.athlete_name));
  const rows=finalists.map(f=>[f.athlete_name, f.team, '']);
  table(doc,10,22,['Athlete','Team','Notes'],rows);
  footer(doc,title,1);
  doc.save(`${ev.age_group}_${ev.gender}_${ev.name.replaceAll(' ','_')}_marshalling.pdf`);
}
async function pdfAllMarshalling(){
  const ag=$('#repAge').value.trim(), g=$('#repGender').value.trim();
  const [S,E,EN,A,R]=await Promise.all([getSettings(),all('events'),all('entries'),all('athletes'),all('results')]);
  const evs=E.filter(e=>e.age_group===ag&&e.gender===g&&e.advance_n>0).sort((a,b)=>a.name.localeCompare(b.name));
  if(!evs.length) return alert('No events with finalists configured (Advance N).');
  const doc=new jsPDF({unit:'mm',format:'a4'}); if(S.default_pdf_draft) drawWatermark(doc,'DRAFT'); let page=1;
  for(let i=0;i<evs.length;i++){
    if(i>0){doc.addPage(); page++; if(S.default_pdf_draft) drawWatermark(doc,'DRAFT');}
    const ev=evs[i]; const title=`${ag} ${g} — ${ev.name} (Final Marshalling)`; doc.setFontSize(16); doc.text(title,10,14); doc.setFontSize(10);
    const ens=EN.filter(en=>en.event_id===ev.id).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return {...en, athlete_name:`${a.first} ${a.last}`, team:a.team||''};});
    const placings=rankAndScore(ev, ens, R, S); const ids=selectFinalists(ev, placings);
    const finalists=ens.filter(en=>ids.includes(en.id)).sort((a,b)=> a.athlete_name.localeCompare(b.athlete_name));
    const rows=finalists.map(f=>[f.athlete_name, f.team, '']);
    table(doc,10,20,['Athlete','Team','Notes'],rows);
    footer(doc,`${ag} ${g} — Finals Marshalling`,page);
  }
  doc.save(`${ag}_${g}_finals_marshalling.pdf`);
}

/* standings & CSVs */
async function computeStandings(ag,g){const [E,EN,R,A,S]=await Promise.all([all('events'),all('entries'),all('results'),all('athletes'),getSettings()]);
  const evs=E.filter(e=>e.age_group===ag&&e.gender===g); const totals=new Map();
  for(const e of evs){const ens=EN.filter(en=>en.event_id===e.id).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return {...en, athlete_name:`${a.first} ${a.last}`, team:a.team||''};});
    const placings=rankAndScore(e,ens,R,S); placings.filter(p=>p.place>0).forEach(p=>{const aid=ens.find(x=>x.id===p.entry_id).athlete_id; totals.set(aid,(totals.get(aid)||0)+p.points);});}
  const rows=Array.from(totals.entries()).map(([aid,pts])=>{const a=A.find(x=>x.id===aid); return {name:`${a.first} ${a.last}`, team:a.team||'', points:pts};})
    .sort((x,y)=> y.points-x.points || x.name.localeCompare(y.name)); return rows;}
async function computeHouseTotals(ag,g){const s=await computeStandings(ag,g); const sums=new Map(); s.forEach(r=>sums.set(r.team,(sums.get(r.team)||0)+r.points));
  return Array.from(sums.entries()).map(([team,pts])=>({team:team||'—', points:pts})).sort((a,b)=> b.points-a.points || a.team.localeCompare(b.team));}
async function csvPlacings(evId){const [E,S]=await Promise.all([all('events'),getSettings()]); const e=E.find(x=>x.id==evId); const p=await buildPlacings(evId);
  const lines=[csvHeader(S),'Event,Age Group,Gender,Place,Qualified,Athlete,Team,Raw Result,Points'];
  p.filter(r=>r.place>0).forEach(r=>lines.push([e.name,e.age_group,e.gender,(r.tie_span>1?'T':'')+r.place,'',r.athlete_name,r.team,r.raw,r.points.toFixed(2)].join(',')));
  downloadText(`${e.age_group}_${e.gender}_${e.name.replaceAll(' ','_')}_placings.csv`,lines.join('\n'));}
async function csvScorers(evId){const [E,S]=await Promise.all([all('events'),getSettings()]); const e=E.find(x=>x.id==evId); const p=await buildPlacings(evId);
  const lines=[csvHeader(S),'Event,Age Group,Gender,Athlete,Team,Place,Points,Raw Result'];
  p.filter(r=>r.place>0&&r.points>0).forEach(r=>lines.push([e.name,e.age_group,e.gender,r.athlete_name,r.team,(r.tie_span>1?'T':'')+r.place,r.points.toFixed(2),r.raw].join(',')));
  downloadText(`${e.age_group}_${e.gender}_${e.name.replaceAll(' ','_')}_scorers.csv`,lines.join('\n'));}
async function csvStandings(ag,g){const S=await getSettings(); const rows=await computeStandings(ag,g);
  const lines=[csvHeader(S),'Rank,Athlete,Team,Total Points']; rows.forEach((r,i)=>lines.push([i+1,r.name,r.team,r.points.toFixed(2)].join(',')));
  downloadText(`${ag}_${g}_standings.csv`,lines.join('\n'));}
async function csvHouseTotals(ag,g){const S=await getSettings(); const rows=await computeHouseTotals(ag,g);
  const lines=[csvHeader(S),'Rank,Team/House,Total Points']; rows.forEach((r,i)=>lines.push([i+1,r.team,r.points.toFixed(2)].join(',')));
  downloadText(`${ag}_${g}_house_totals.csv`,lines.join('\n'));}
async function csvBreakdown(ag,g,exZero){const S=await getSettings(); const [E,EN,R,A]=await Promise.all([all('events'),all('entries'),all('results'),all('athletes')]);
  const evs=E.filter(e=>e.age_group===ag&&e.gender===g); const totals=new Map(); const rows=[];
  for(const e of evs){const ens=EN.filter(en=>en.event_id===e.id).map(en=>{const a=A.find(x=>x.id===en.athlete_id); return {...en, athlete_name:`${a.first} ${a.last}`, team:a.team||''};});
    const p=rankAndScore(e,ens,R,await getSettings()); p.filter(x=>x.place>0).forEach(x=>{const aid=ens.find(q=>q.id===x.entry_id).athlete_id; totals.set(aid,(totals.get(aid)||0)+x.points);
      if(!exZero||x.points>0){rows.push({aid, athlete:ens.find(q=>q.id===x.entry_id).athlete_name, team:ens.find(q=>q.id===x.entry_id).team, event:e.name, place:x.place, points:x.points, raw:x.raw});}});}
  const ranked=Array.from(totals.entries()).sort((a,b)=>b[1]-a[1]); const rankMap=new Map(ranked.map(([aid,_],i)=>[aid,i+1]));
  const out=[csvHeader(S),'Rank,Athlete,Team,Event,Place,Points,Raw Result'];
  rows.sort((a,b)=>(rankMap.get(a.aid)-rankMap.get(b.aid))||a.event.localeCompare(b.event))
    .forEach(r=>out.push([rankMap.get(r.aid),r.athlete,r.team,r.event,r.place,r.points.toFixed(2),r.raw].join(',')));
  downloadText(`${ag}_${g}_age_champion_breakdown.csv`,out.join('\n'));}

/* import / seed */
async function importAthletesCSV(text){
  const msg = document.getElementById('importMsg');
  const raw = (text || '').replace(/^\uFEFF/, '').replace(/\r/g, '\n');
  const rows = raw.split('\n').map(s => s.trim()).filter(s => s.length > 0);
  if (!rows.length) { msg.style.display='block'; msg.style.background='#fef3c7'; msg.style.color='#92400e'; msg.textContent='Nothing to import — the box is empty.'; return; }
  const splitRow = (line) => { const sep = line.includes('\t') ? '\t' : (line.includes(';') ? ';' : ','); return line.split(sep).map(x => x.trim()); };
  let added=0; const bad=[];
  for (const line of rows) {
    const parts = splitRow(line);
    if (parts.length < 4) { bad.push({line, reason:'needs at least First,Last,Gender,AgeGroup'}); continue; }
    const [first,last,gender,age,team=''] = parts;
    if (!first||!last||!gender||!age) { bad.push({line,reason:'missing required fields'}); continue; }
    try { await put('athletes',{first,last,gender,age_group:age,team}); added++; } catch(e){ bad.push({line,reason:'storage error'}); }
  }
  await refreshAthletes();
  msg.style.display='block';
  if (!bad.length){ msg.style.background='#dcfce7'; msg.style.color='#065f46'; msg.textContent=`Imported ${added} athlete${added===1?'':'s'}.`; }
  else { msg.style.background='#fef3c7'; msg.style.color='#92400e'; const preview=bad.slice(0,3).map(b=>`• ${b.reason}: ${b.line}`).join('\n'); msg.textContent=`Imported ${added}. Skipped ${bad.length} line${bad.length===1?'':'s'}:\n${preview}${bad.length>3?'\n…':''}`; }
}
async function addEvent(name,type,gender,age){
  const S=await getSettings();
  const d=S.age_validation_defaults[age]||{};
  const track=d.track||{};
  const field=d.field||{};
  await put('events',{
    name,type,gender,age_group:age,
    scoring_table:null,
    qualify_mode:'disabled',qualify_top_n:null,qualify_standard_raw:null,qualify_cap:null,cap_policy:'include_ties',
    round_type:'final',advance_mode:'place',advance_n:null,
    val_min_time_ms: type==='track_time' ? (track.min_time_ms ?? null) : null,
    val_max_time_ms: type==='track_time' ? (track.max_time_ms ?? null) : null,
    val_min_dist_mm: type==='field_distance' ? (field.min_dist_mm ?? null) : null,
    val_max_dist_mm: type==='field_distance' ? (field.max_dist_mm ?? null) : null
  });
  await refreshEventsFilters();
}
async function addEntriesForEvent(eventId, age, gender){
  const [A] = await Promise.all([all('athletes')]);
  const AA=A.filter(a=>a.age_group===age&&a.gender===gender);
  for(const a of AA){
    await put('entries',{id:`${eventId}-${a.id}`, event_id:eventId, athlete_id:a.id, heat:1, athlete_name:`${a.first} ${a.last}`, team:a.team||''});
  }
}
async function autoEntries(age,gender){
  const [A,E]=await Promise.all([all('athletes'),all('events')]);
  const AA=A.filter(a=>a.age_group===age&&a.gender===gender), EE=E.filter(e=>e.age_group===age&&e.gender===gender);
  for(const e of EE){ for(const a of AA){ await put('entries',{id:`${e.id}-${a.id}`, event_id:e.id, athlete_id:a.id, heat:1, athlete_name:`${a.first} ${a.last}`, team:a.team||''}); } }
}
async function seedDemo(){const csv=`Alex,Smith,Girls,U13,Fraser
Jamie,Lee,Girls,U13,Bradman
Riley,Chen,Girls,U13,Cuthbert
Taylor,Nguyen,Girls,U13,Fraser
Jordan,Khan,Girls,U13,Bradman
Casey,Wong,Girls,U13,Cuthbert`;
  await importAthletesCSV(csv);
  await addEvent('100m Final','track_time','Girls','U13'); await addEvent('Long Jump Final','field_distance','Girls','U13'); await autoEntries('U13','Girls');
  const [E,EN]=await Promise.all([all('events'),all('entries')]); const ev100=E.find(e=>e.name==='100m Final'&&e.age_group==='U13'&&e.gender==='Girls'); const evLJ=E.find(e=>e.name==='Long Jump Final'&&e.age_group==='U13'&&e.gender==='Girls');
  ev100.advance_mode='place'; ev100.advance_n=4; await put('events',ev100);
  evLJ.advance_mode='place'; evLJ.advance_n=4; await put('events',evLJ);
  const names=(n)=>EN.find(en=>en.event_id===ev100.id&&en.athlete_name.startsWith(n)); const e2=(n)=>EN.find(en=>en.event_id===evLJ.id&&en.athlete_name.startsWith(n));
  const tmap={'Alex':'12.00','Jamie':'12.00','Riley':'12.40','Taylor':'12.60','Jordan':'12.80','Casey':'13.00'};
  for(const [nm,raw] of Object.entries(tmap)){const en=names(nm); await put('results',{entry_id:en.id,raw_value:raw,normalized_value:parseTimeToMs(raw),wind:'',notes:''});}
  const lmap={'Riley':'4.55','Alex':'4.48','Jamie':'4.42','Taylor':'4.30','Jordan':'4.15','Casey':'3.95'};
  for(const [nm,raw] of Object.entries(lmap)){const en=e2(nm); await put('results',{entry_id:en.id,raw_value:raw,normalized_value:parseDistToMm(raw),wind:'',notes:''});}
  await refreshAthletes(); await refreshEventsFilters(); alert('Demo seeded: U13 Girls • 6 athletes • finalists preconfigured.');
}

/* duplicate */
async function duplicateEvent(){
  const [E]=await Promise.all([all('events')]);
  const srcId=parseInt($('#dupSource').value,10);
  const src=E.find(e=>e.id==srcId); if(!src) return alert('Pick a source event.');
  const name=$('#dupName').value.trim()||src.name;
  const age=$('#dupAge').value.trim(); const gender=$('#dupGender').value.trim();
  if(!age) return alert('Enter target age group.');
  const copyAdv=$('#dupCopyAdv').checked; const auto=$('#dupAutoEntries').checked;
  const valFromId=$('#dupValFrom').value?parseInt($('#dupValFrom').value,10):null;
  const valFrom = valFromId ? E.find(e=>e.id===valFromId) : null;

  const newEv={
    name, type:src.type, gender, age_group:age,
    scoring_table:src.scoring_table||null,
    qualify_mode: copyAdv ? (src.qualify_mode||'disabled') : 'disabled',
    qualify_top_n: copyAdv ? (src.qualify_top_n||null) : null,
    qualify_standard_raw: copyAdv ? (src.qualify_standard_raw||null) : null,
    qualify_cap: copyAdv ? (src.qualify_cap||null) : null,
    cap_policy: copyAdv ? (src.cap_policy||'include_ties') : 'include_ties',
    round_type: 'final',
    advance_mode: copyAdv ? (src.advance_mode||'place') : 'place',
    advance_n: copyAdv ? (src.advance_n||null) : null,
    val_min_time_ms: valFrom ? (valFrom.val_min_time_ms??null) : (src.val_min_time_ms??null),
    val_max_time_ms: valFrom ? (valFrom.val_max_time_ms??null) : (src.val_max_time_ms??null),
    val_min_dist_mm:  valFrom ? (valFrom.val_min_dist_mm??null) : (src.val_min_dist_mm??null),
    val_max_dist_mm:  valFrom ? (valFrom.val_max_dist_mm??null) : (src.val_max_dist_mm??null)
  };
  const newId=await put('events', newEv);
  if(auto){ await addEntriesForEvent(newId, age, gender); }
  await refreshEventsFilters();
  alert(`Event duplicated as "${name}" for ${age} ${gender}${auto?', with entries.':''}`);
}

/* standard event set */
const STANDARD_EVENTS=[
  {name:'100m Final', type:'track_time'},
  {name:'200m Final', type:'track_time'},
  {name:'400m Final', type:'track_time'},
  {name:'800m Final', type:'track_time'},
  {name:'1500m Final', type:'track_time'},
  {name:'Long Jump Final', type:'field_distance'},
  {name:'High Jump Final', type:'field_distance'},
  {name:'Shot Put Final', type:'field_distance'},
  {name:'Discus Final', type:'field_distance'},
  {name:'Javelin Final', type:'field_distance'},
  {name:'Relay 4x100 Final', type:'track_time'}
];
async function createStandardEventSet(age, gender, auto){
  if(!age) return alert('Enter Age Group (e.g., U13).');
  for(const e of STANDARD_EVENTS){ await addEvent(e.name, e.type, gender, age); }
  if(auto){
    const [E]=await Promise.all([all('events')]);
    const newEvents=E.filter(ev=>ev.age_group===age && ev.gender===gender && STANDARD_EVENTS.some(se=>se.name===ev.name));
    for(const ev of newEvents){ await addEntriesForEvent(ev.id, age, gender); }
  }
  await refreshEventsFilters();
  alert(`Created ${STANDARD_EVENTS.length} events for ${age} ${gender}${auto?' and enrolled athletes.':''}`);
}

/* BULK wizard */
function parseAgeList(raw){ return (raw||'').split(/[\s,]+/).map(s=>s.trim()).filter(Boolean); }
async function bulkCreateEventSets(){
  const ages=parseAgeList($('#bulkAges').value);
  const useGirls=$('#bulkGirls').checked;
  const useBoys=$('#bulkBoys').checked;
  const auto=$('#bulkAuto').checked;
  if(!ages.length) return alert('Enter at least one age group.');
  if(!useGirls && !useBoys) return alert('Select at least one gender.');
  for(const age of ages){
    if(useGirls){ await createStandardEventSet(age,'Girls',auto); }
    if(useBoys){ await createStandardEventSet(age,'Boys',auto); }
  }
  alert(`Bulk wizard finished for ${ages.length} age group(s) × ${useGirls&&useBoys?2:1} gender(s).`);
}

/* validation */
function validatePerformance(ev, raw){
  if(!raw) return null;
  if(ev.type==='track_time'){
    const ms=parseTimeToMs(raw); if(ms==null) return 'Unparseable time';
    const min=ev.val_min_time_ms ?? 5000;
    const max=ev.val_max_time_ms ?? 600000;
    if(ms<min) return `< ${ (min/1000).toFixed(2) }s (check)`;
    if(ms>max) return `> ${ (max/1000).toFixed(2) }s (check)`;
    return null;
  }else if(ev.type==='field_distance'){
    const mm=parseDistToMm(raw); if(mm==null) return 'Unparseable distance';
    const min=ev.val_min_dist_mm ?? 500;
    const max=ev.val_max_dist_mm ?? 20000;
    if(mm<min) return `< ${(min/1000).toFixed(2)} m (check)`;
    if(mm>max) return `> ${(max/1000).toFixed(2)} m (check)`;
    return null;
  }
  return null;
}

/* validation editor helpers */
async function loadValidationForm(){
  const id=parseInt($('#valEvent').value,10);
  const [E]=await Promise.all([all('events')]); const ev=E.find(e=>e.id==id); if(!ev) return;
  $('#valMinTime').value = ev.val_min_time_ms!=null ? (ev.val_min_time_ms/1000).toFixed(2) : '';
  $('#valMaxTime').value = ev.val_max_time_ms!=null ? (ev.val_max_time_ms/1000).toFixed(2) : '';
  $('#valMinDist').value = ev.val_min_dist_mm!=null ? (ev.val_min_dist_mm/1000).toFixed(2) : '';
  $('#valMaxDist').value = ev.val_max_dist_mm!=null ? (ev.val_max_dist_mm/1000).toFixed(2) : '';
}
async function resetEventValidation(eventId){
  const [E]=await Promise.all([all('events')]); const ev=E.find(e=>e.id==eventId); if(!ev) return;
  ev.val_min_time_ms=null; ev.val_max_time_ms=null; ev.val_min_dist_mm=null; ev.val_max_dist_mm=null;
  await put('events',ev);
  await loadValidationForm();
  await refreshEventsFilters();
  alert('Validation ranges cleared for this event.');
}

/* Settings: per-age defaults table */
async function renderAgeDefaultsTable(){
  const s=await getSettings(); const map=s.age_validation_defaults||{};
  const ages=Object.keys(map).sort((a,b)=>a.localeCompare(b));
  const rows=ages.map(age=>{
    const t=map[age].track||{}; const f=map[age].field||{};
    const trackTxt = (t.min_time_ms!=null||t.max_time_ms!=null) ? `${msToS(t.min_time_ms)}s–${msToS(t.max_time_ms)}s` : '—';
    const fieldTxt = (f.min_dist_mm!=null||f.max_dist_mm!=null) ? `${mmToM(f.min_dist_mm)}–${mmToM(f.max_dist_mm)} m` : '—';
    return `<tr><td>${age}</td><td>${trackTxt}</td><td>${fieldTxt}</td><td><button data-age="${age}" class="btnRemoveAgeDef secondary">Remove</button></td></tr>`;
  }).join('');
  $('#tblAgeDefaults').innerHTML = `<tr><th>Age</th><th>Track ranges</th><th>Field ranges</th><th></th></tr>${rows||''}`;
  document.querySelectorAll('.btnRemoveAgeDef').forEach(b=>b.addEventListener('click', async ()=>{
    const age=b.dataset.age; const s=await getSettings(); delete s.age_validation_defaults[age]; await put('settings',s); await renderAgeDefaultsTable();
  }));
}
async function saveAgeDefaults(){
  const age=$('#ageDefAge').value.trim();
  const tKey=$('#ageDefTrackPreset').value;
  const fKey=$('#ageDefFieldPreset').value;
  if(!age) return alert('Enter an age group (e.g., U13).');
  if(!tKey && !fKey) return alert('Choose at least one preset.');
  const s=await getSettings(); s.age_validation_defaults = s.age_validation_defaults||{};
  s.age_validation_defaults[age] = s.age_validation_defaults[age] || {};
  if(tKey){
    const r=applyPresetToRanges(tKey);
    s.age_validation_defaults[age].track = { min_time_ms:r.min_time_ms??null, max_time_ms:r.max_time_ms??null };
  }
  if(fKey){
    const r=applyPresetToRanges(fKey);
    s.age_validation_defaults[age].field = { min_dist_mm:r.min_dist_mm??null, max_dist_mm:r.max_dist_mm??null };
  }
  await put('settings',s);
  await renderAgeDefaultsTable();
  alert(`Saved defaults for ${age}.`);
}
async function clearAgeDefaults(){
  const age=$('#ageDefAge').value.trim(); if(!age) return alert('Enter an age to clear.');
  const s=await getSettings(); if(!s.age_validation_defaults[age]) return alert('No defaults for that age.');
  delete s.age_validation_defaults[age]; await put('settings',s); await renderAgeDefaultsTable(); alert(`Cleared defaults for ${age}.`);
}

/* === Undo snapshot === */
let lastApplySnapshot=null;
async function snapshotEvents(){
  const E=await all('events');
  lastApplySnapshot=E.map(e=>({...e})); /* why: allow rollback of bulk apply */
}
async function undoLastApply(){
  if(!lastApplySnapshot){ alert('No previous apply to undo.'); return; }
  for(const ev of lastApplySnapshot){ await put('events',ev); }
  lastApplySnapshot=null;
  await refreshEventsFilters();
  alert('Undo complete: events restored to previous state.');
}

/* === PREVIEW/APPLY HELPERS === */
function eq(a,b){ return (a??null)===(b??null); }
function diffText(oldV,newV,unit){
  const o=oldV==null?'—':String(unit==='s'?msToS(oldV):mmToM(oldV));
  const n=newV==null?'—':String(unit==='s'?msToS(newV):mmToM(newV));
  return `${o} → ${n}`;
}
async function computeAgeDefaultChanges(ages){
  const s=await getSettings(); const map=s.age_validation_defaults||{};
  const [E]=await Promise.all([all('events')]);
  const setAges = new Set(ages);
  const list=[];
  for(const ev of E){
    if(!setAges.has(ev.age_group)) continue;
    const d=map[ev.age_group]||{};
    if(ev.type==='track_time' && d.track){
      const nt=d.track;
      const chMin=!eq(ev.val_min_time_ms, nt.min_time_ms);
      const chMax=!eq(ev.val_max_time_ms, nt.max_time_ms);
      if(chMin||chMax){
        list.push({event:ev, kind:'track', minOld:ev.val_min_time_ms, minNew:nt.min_time_ms, maxOld:ev.val_max_time_ms, maxNew:nt.max_time_ms});
      }
    }
    if(ev.type==='field_distance' && d.field){
      const nf=d.field;
      const chMin=!eq(ev.val_min_dist_mm, nf.min_dist_mm);
      const chMax=!eq(ev.val_max_dist_mm, nf.max_dist_mm);
      if(chMin||chMax){
        list.push({event:ev, kind:'field', minOld:ev.val_min_dist_mm, minNew:nf.min_dist_mm, maxOld:ev.val_max_dist_mm, maxNew:nf.max_dist_mm});
      }
    }
  }
  const byAge = new Map();
  list.forEach(c=>byAge.set(c.event.age_group,(byAge.get(c.event.age_group)||0)+1));
  return { list, byAge };
}
function formatPreview(changes){
  const lines=[];
  const ages=[...changes.byAge.keys()].sort((a,b)=>a.localeCompare(b));
  lines.push(`Events to update: ${changes.list.length}`);
  if(ages.length){ lines.push('Per-age: '+ages.map(a=>`${a}:${changes.byAge.get(a)}`).join(' · ')); }
  const maxLines=12;
  for(let i=0;i<Math.min(maxLines,changes.list.length);i++){
    const c=changes.list[i], ev=c.event;
    const unit = c.kind==='track'?'s':'m';
    lines.push(`• ${ev.age_group} ${ev.gender} — ${ev.name} [${c.kind}]  min ${diffText(c.minOld,c.minNew,unit)}, max ${diffText(c.maxOld,c.maxNew,unit)}`);
  }
  if(changes.list.length>maxLines) lines.push(`…and ${changes.list.length-maxLines} more`);
  lines.push('');
  lines.push('Apply these changes now?');
  return lines.join('\n');
}
async function applyDefaultsForAges(ages){
  const s=await getSettings(); const map=s.age_validation_defaults||{};
  const [E]=await Promise.all([all('events')]);
  const setAges=new Set(ages);
  let changed=0;
  for(const ev of E){
    if(!setAges.has(ev.age_group)) continue;
    const d=map[ev.age_group]||{};
    let touched=false;
    if(ev.type==='track_time' && d.track){
      const t=d.track;
      if(!eq(ev.val_min_time_ms,t.min_time_ms)){ ev.val_min_time_ms=t.min_time_ms??null; touched=true; }
      if(!eq(ev.val_max_time_ms,t.max_time_ms)){ ev.val_max_time_ms=t.max_time_ms??null; touched=true; }
    }
    if(ev.type==='field_distance' && d.field){
      const f=d.field;
      if(!eq(ev.val_min_dist_mm,f.min_dist_mm)){ ev.val_min_dist_mm=f.min_dist_mm??null; touched=true; }
      if(!eq(ev.val_max_dist_mm,f.max_dist_mm)){ ev.val_max_dist_mm=f.max_dist_mm??null; touched=true; }
    }
    if(touched){ await put('events',ev); changed++; }
  }
  await refreshEventsFilters();
  return changed;
}

/* APPLY defaults: single age */
async function applyAgeDefaultsToEvents(age){
  if(!age) return alert('Enter an age (e.g., U13).');
  const s=await getSettings(); if(!(s.age_validation_defaults||{})[age]) return alert('No saved defaults for that age.');
  const previewFirst = $('#chkPreviewApply').checked;
  if(previewFirst){
    const changes=await computeAgeDefaultChanges([age]);
    if(!changes.list.length) return alert('No changes needed.');
    const ok=confirm(formatPreview(changes));
    if(!ok) return;
  }
  await snapshotEvents(); /* why: enable undo */
  const changed=await applyDefaultsForAges([age]);
  alert(`Applied age defaults to ${changed} event${changed===1?'':'s'} for ${age}.`);
}

/* APPLY defaults: ALL ages */
async function applyAllAgeDefaultsToEvents(){
  const s=await getSettings(); const ages=Object.keys(s.age_validation_defaults||{});
  if(!ages.length) return alert('No saved age defaults.');
  const previewFirst = $('#chkPreviewApply').checked;
  if(previewFirst){
    const changes=await computeAgeDefaultChanges(ages);
    if(!changes.list.length) return alert('No changes needed.');
    const ok=confirm(formatPreview(changes));
    if(!ok) return;
  }
  await snapshotEvents(); /* why: enable undo */
  const changed=await applyDefaultsForAges(ages);
  alert(`Applied ALL age defaults.\nTotal events updated: ${changed}`);
}

/* EXPORT age defaults CSV (actual data) */
async function exportAgeDefaultsCSV(){
  const s=await getSettings(); const map=s.age_validation_defaults||{};
  const lines=['Age,Type,MinTimeS,MaxTimeS,MinDistM,MaxDistM'];
  for(const [age,defs] of Object.entries(map)){
    const t=defs.track||{}; const f=defs.field||{};
    if(t.min_time_ms!=null || t.max_time_ms!=null){
      lines.push([age,'track',msToS(t.min_time_ms),msToS(t.max_time_ms),'',''].join(','));
    }
    if(f.min_dist_mm!=null || f.max_dist_mm!=null){
      lines.push([age,'field','','',mmToM(f.min_dist_mm),mmToM(f.max_dist_mm)].join(','));
    }
  }
  if(lines.length===1){ /* why: still give a valid file */
    lines.push('U12,track,8,120,,');
    lines.push('U12,field,,,1.50,8.00');
  }
  downloadText('age_validation_defaults.csv', lines.join('\n'));
}

/* EXPORT template CSV (static) */
function exportAgeDefaultsTemplate(){
  const tpl=`Age,Type,MinTimeS,MaxTimeS,MinDistM,MaxDistM
U12,track,8,120,,
U12,field,,,1.50,8.00
U13,track,9,150,,
U13,field,,,2.00,12.00`;
  downloadText('age_validation_template.csv', tpl);
}

/* IMPORT age defaults CSV + status + optional auto-apply */
async function importAgeDefaultsCSV(text){
  const raw = (text||'').replace(/^\uFEFF/,'').replace(/\r/g,'\n');
  const rows = raw.split('\n').map(s=>s.trim()).filter(Boolean);
  if(!rows.length) return alert('CSV is empty.');
  const header = rows[0].toLowerCase();
  const split = (line)=>{ const sep = line.includes('\t')?'\t':(line.includes(';')?';':','); return line.split(sep).map(x=>x.trim()); };
  let startIdx=0;
  if(header.includes('age') && header.includes('type')) startIdx=1;
  const s=await getSettings(); s.age_validation_defaults = s.age_validation_defaults||{};
  const beforeAges=new Set(Object.keys(s.age_validation_defaults));
  let up=0, skipped=0;
  const touchedAges=new Set();
  for(let i=startIdx;i<rows.length;i++){
    const parts=split(rows[i]);
    if(parts.length<2){ skipped++; continue; }
    const [age,type,minTimeS,maxTimeS,minDistM,maxDistM] = parts;
    if(!age||!type){ skipped++; continue; }
    const tp = type.toLowerCase();
    s.age_validation_defaults[age]=s.age_validation_defaults[age]||{};
    if(tp.startsWith('track')){
      const mt = parseFloat(minTimeS); const xt=parseFloat(maxTimeS);
      s.age_validation_defaults[age].track = {
        min_time_ms: Number.isFinite(mt)? Math.round(mt*1000): null,
        max_time_ms: Number.isFinite(xt)? Math.round(xt*1000): null
      };
      up++; touchedAges.add(age);
    } else if(tp.startsWith('field')){
      const md = parseFloat(minDistM); const xd=parseFloat(maxDistM);
      s.age_validation_defaults[age].field = {
        min_dist_mm: Number.isFinite(md)? Math.round(md*1000): null,
        max_dist_mm: Number.isFinite(xd)? Math.round(xd*1000): null
      };
      up++; touchedAges.add(age);
    } else { skipped++; }
  }
  await put('settings',s);
  await renderAgeDefaultsTable();
  const created = [...touchedAges].filter(a=>!beforeAges.has(a));
  const updated = [...touchedAges].filter(a=>beforeAges.has(a));
  const status = `Created: ${created.length?created.join(', '):'—'} | Updated: ${updated.length?updated.join(', '):'—'} | Rows: ${up} | Skipped: ${skipped}`;
  document.getElementById('ageDefImportStatus').textContent = status;
  alert(`Imported ${up} row${up===1?'':'s'}${skipped?`, skipped ${skipped}`:''}.\n${status}`);

  if($('#chkApplyAfterImport').checked && touchedAges.size){
    const ages=[...touchedAges];
    const changes=await computeAgeDefaultChanges(ages);
    if(!changes.list.length) return alert('No events need updates after this import.');
    const ok=confirm(`After import → preview\n\n${formatPreview(changes)}`);
    if(!ok) return;
    await snapshotEvents(); /* why: enable undo */
    const changed=await applyDefaultsForAges(ages);
    alert(`Applied imported defaults to ${changed} event${changed===1?'':'s'}.`);
  }
}

/* install prompt */
let deferredPrompt=null; window.addEventListener('beforeinstallprompt',e=>{e.preventDefault(); deferredPrompt=e; $('#btnInstall').hidden=false;});
$('#btnInstall').addEventListener('click', async ()=>{if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; $('#btnInstall').hidden=true; deferredPrompt=null;});

/* nav */
document.querySelectorAll('nav button').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('nav button').forEach(bb=>bb.classList.toggle('active',bb===b)); document.querySelectorAll('section.tab').forEach(sec=>sec.classList.toggle('active',sec.id===`tab-${b.dataset.tab}`));}));

/* buttons */
$('#btnImportAth').addEventListener('click',async()=>{await importAthletesCSV($('#csvAth').value);});
$('#btnSampleCsv').addEventListener('click',()=>{$('#csvAth').value=`Alex,Smith,Girls,U13,Fraser
Jamie,Lee,Girls,U13,Bradman
Riley,Chen,Girls,U13,Cuthbert
Noah,Brown,Boys,U12,Fraser
Leo,Patel,Boys,U12,Cuthbert
Owen,Harris,Boys,U13,Bradman`;});
$('#btnSeedDemo').addEventListener('click',seedDemo);
$('#btnAddEvent').addEventListener('click',async()=>{await addEvent($('#evName').value.trim(),$('#evType').value,$('#evGender').value,$('#evAge').value.trim()); alert('Event added.');});
$('#btnEventWizard').addEventListener('click',async()=>{await createStandardEventSet($('#wizAge').value.trim(), $('#wizGender').value.trim(), $('#wizAuto').checked);});
$('#btnBulkWizard').addEventListener('click',bulkCreateEventSets);
$('#btnAutoEntries').addEventListener('click',async()=>{await autoEntries($('#autoAge').value.trim(),$('#autoGender').value.trim()); alert('Entries created.');});
$('#btnFilterEv').addEventListener('click',refreshEventsFilters);
$('#filterCustomOnly').addEventListener('change',refreshEventsFilters);
$('#btnLoadEntries').addEventListener('click',async()=>{const id=parseInt($('#resEvent').value,10); await loadEntriesForEvent(id);});

/* results save */
$('#btnSaveResults').addEventListener('click',async()=>{
  const evId=parseInt($('#resEvent').value,10);
  const [E]=await Promise.all([all('events')]); const ev=E.find(e=>e.id==evId);
  const resInputs=[...document.querySelectorAll('.resInput')];
  const windInputs=[...document.querySelectorAll('.windInput')];
  const windMap=new Map(windInputs.map(i=>[i.dataset.wind,i.value.trim()]));
  const warnings=[];
  resInputs.forEach(inp=>inp.classList.remove('warn'));
  for(const inp of resInputs){
    const entryId=inp.dataset.entry; const raw=inp.value.trim();
    const warn=validatePerformance(ev, raw);
    if(warn){ warnings.push(`${entryId}: ${warn} (${raw})`); inp.classList.add('warn'); }
    let norm=null; if(raw) norm=ev.type==='track_time'?parseTimeToMs(raw):parseDistToMm(raw);
    if(norm!=null) await put('results',{entry_id:entryId,raw_value:raw,normalized_value:norm,wind:windMap.get(entryId)||'',notes:''});
    else await del('results',entryId);
  }
  const box=$('#valMsg');
  if(warnings.length){ box.style.display='block'; box.textContent='⚠️ Suspicious values:\n- '+warnings.slice(0,8).join('\n- ')+(warnings.length>8?'\n…':''); }
  else { box.style.display='none'; box.textContent=''; }
  alert('Results saved.');
});
$('#btnClearResults').addEventListener('click',async()=>{const evId=parseInt($('#resEvent').value,10); const EN=await all('entries'); const evEntries=EN.filter(en=>en.event_id==evId); for(const en of evEntries) await del('results',en.id); await loadEntriesForEvent(evId);});

/* duplicate/save settings */
$('#btnDuplicateEvent').addEventListener('click',duplicateEvent);
$('#btnSaveAdv').addEventListener('click', async ()=>{
  const id=parseInt($('#advEvent').value,10); const [E]=await Promise.all([all('events')]); const ev=E.find(e=>e.id==id);
  ev.qualify_mode=$('#qualMode').value;
  ev.qualify_top_n=parseInt($('#qualTopN').value,10)||null;
  ev.qualify_standard_raw=$('#qualStd').value.trim()||null;
  ev.qualify_cap=parseInt($('#qualCap').value,10)||null;
  ev.cap_policy=$('#capPolicy').value;
  ev.advance_mode=$('#advMode').value;
  ev.advance_n=parseInt($('#advN').value,10)||null;
  await put('events',ev); alert('Advancement saved.');
});

/* validation editor */
$('#valEvent').addEventListener('change', loadValidationForm);
$('#btnApplyPreset').addEventListener('click', ()=>{ const key=$('#valPreset').value; if(!key) return alert('Choose a preset.'); applyPresetToInputs(key); });
$('#btnSaveVal').addEventListener('click', async ()=>{
  const id=parseInt($('#valEvent').value,10); const [E]=await Promise.all([all('events')]); const ev=E.find(e=>e.id==id);
  const mt=parseFloat($('#valMinTime').value); const xt=parseFloat($('#valMaxTime').value);
  const md=parseFloat($('#valMinDist').value); const xd=parseFloat($('#valMaxDist').value);
  ev.val_min_time_ms=Number.isFinite(mt)?Math.round(mt*1000):null;
  ev.val_max_time_ms=Number.isFinite(xt)?Math.round(xt*1000):null;
  ev.val_min_dist_mm=Number.isFinite(md)?Math.round(md*1000):null;
  ev.val_max_dist_mm=Number.isFinite(xd)?Math.round(xd*1000):null;
  await put('events',ev); await refreshEventsFilters(); alert('Validation ranges saved.');
});
$('#btnResetVal').addEventListener('click', async ()=>{
  const id=parseInt($('#valEvent').value,10); await resetEventValidation(id);
});

/* per-age defaults buttons */
$('#btnSaveAgeDef').addEventListener('click', saveAgeDefaults);
$('#btnClearAgeDef').addEventListener('click', clearAgeDefaults);
$('#btnApplyAgeDefaultsToEvents').addEventListener('click', async ()=>{
  await applyAgeDefaultsToEvents($('#applyAgeFor').value.trim() || $('#ageDefAge').value.trim());
});
$('#btnApplyAllAgeDefaultsToEvents').addEventListener('click', applyAllAgeDefaultsToEvents);
$('#btnUndoApply').addEventListener('click', undoLastApply);

/* import/export age defaults */
$('#btnExportAgeDefaultsCsv').addEventListener('click', exportAgeDefaultsCSV);
$('#btnExportAgeDefaultsTemplate').addEventListener('click', exportAgeDefaultsTemplate);
$('#btnImportAgeDefaultsCsv').addEventListener('click', ()=>$('#ageDefCsvFile').click());
$('#ageDefCsvFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{ const text=await f.text(); await importAgeDefaultsCSV(text); }
  catch(err){ alert('Import failed: '+(err?.message||err)); }
  finally{ e.target.value=''; }
});

/* global settings helpers */
function updateCsvPreviewUI(){getSettings().then(s=>{const state=s.default_pdf_draft?'DRAFT':'FINAL'; const tpl=$('#setCsvTpl').value||'{STATE} generated {TIMESTAMP}'; const line=tpl.replaceAll('{STATE}',state).replaceAll('{TIMESTAMP}',nowStamp()).replace(/\s+/g,' ').trim(); $('#csvHeaderPreview').textContent='# '+line;});}
$('#btnSaveSettings').addEventListener('click',async()=>{const s=await getSettings(); s.default_pdf_draft=$('#setDraft').checked; s.hide_scoring_key=$('#setHideKey').checked; s.csv_header_template=$('#setCsvTpl').value.trim()||'{STATE} generated {TIMESTAMP}'; await put('settings',s); updateCsvPreviewUI(); alert('Settings saved.');});
$('#btnResetOutput').addEventListener('click',async()=>{const s=await getSettings(); s.default_pdf_draft=true; s.hide_scoring_key=false; s.csv_header_template='{STATE} generated {TIMESTAMP}'; await put('settings',s); $('#setDraft').checked=true; $('#setHideKey').checked=false; $('#setCsvTpl').value=s.csv_header_template; updateCsvPreviewUI();});
$('#setCsvTpl').addEventListener('input',updateCsvPreviewUI); $('#setDraft').addEventListener('change',updateCsvPreviewUI);

/* Clear / Backup / Restore */
$('#btnClearAll').addEventListener('click', async ()=>{
  if (!confirm('This will remove ALL athletes, events, entries, and results from this device. Continue?')) return;
  await clearAllData(); alert('All data cleared. The app will reload now.'); location.reload();
});
$('#btnBackup').addEventListener('click', exportBackup);
$('#btnRestore').addEventListener('click', ()=>$('#restoreFile').click());
$('#restoreFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const text=await f.text(); const data=JSON.parse(text);
    const ok=confirm('Restore will REPLACE all existing data on this device. Continue?');
    if(!ok) return;
    await clearAllData();
    db=await idbOpen();
    await restoreFromJson(data);
    alert('Backup restored. The app will reload now.');
    location.reload();
  }catch(err){ alert('Restore failed: '+(err?.message||err)); }
});
async function exportBackup(){
  const payload={
    meta:{exported_at:nowStamp(), version:1},
    athletes: await all('athletes'),
    events: await all('events'),
    entries: await all('entries'),
    results: await all('results'),
    settings: await all('settings')
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`meet-backup-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
}
async function restoreFromJson(json){
  const stores=['athletes','events','entries','results','settings'];
  for(const s of stores){ for(const item of (json[s]||[])){ await put(s,item); } }
}
async function clearAllData(){
  return new Promise((resolve, reject) => {
    const delReq = indexedDB.deleteDatabase(DB_NAME);
    delReq.onerror = () => reject(delReq.error || new Error('Failed to delete DB'));
    delReq.onsuccess = () => resolve();
    delReq.onblocked = () => reject(new Error('Delete blocked (close other tabs)'));
  });
}

/* bootstrap */
(async function init(){
  try { db = await idbOpen(); }
  catch (e){ const alertBox = document.getElementById('storageAlert'); alertBox.style.display = 'block'; console.error('IndexedDB unavailable:', e); return; }
  await put('settings',{...defaultSettings,...await getSettings()});
  await refreshAthletes(); await refreshEventsFilters();
  const s=await getSettings(); $('#setDraft').checked=s.default_pdf_draft; $('#setHideKey').checked=s.hide_scoring_key; $('#setCsvTpl').value=s.csv_header_template; updateCsvPreviewUI();
  if($('#valEvent').options.length>0) { await loadValidationForm(); }
  await renderAgeDefaultsTable();

  /* wire reports/CSVs */
  $('#pdfEvent').addEventListener('click', ()=>pdfPerEvent(true));
  $('#pdfEventSummary').addEventListener('click', ()=>pdfPerEvent(false));
  $('#pdfAgeGroup').addEventListener('click', pdfAgeGroupReport);
  $('#pdfHouseTotals').addEventListener('click', pdfHouse);
  $('#pdfAllSummaries').addEventListener('click', pdfAllSummaries);
  $('#pdfFinalMarshal').addEventListener('click', async()=>{const id=parseInt($('#csvEvent').value,10); await pdfMarshallingForEvent(id);});
  $('#pdfAllMarshalling').addEventListener('click', pdfAllMarshalling);

  $('#csvPlacings').addEventListener('click', async()=>{const id=parseInt($('#csvEvent').value,10); await csvPlacings(id);});
  $('#csvScorers').addEventListener('click', async()=>{const id=parseInt($('#csvEvent').value,10); await csvScorers(id);});
  $('#csvStandings').addEventListener('click', async()=>{await csvStandings($('#repAge').value.trim(),$('#repGender').value.trim());});
  $('#csvHouse').addEventListener('click', async()=>{await csvHouseTotals($('#repAge').value.trim(),$('#repGender').value.trim());});
  $('#csvBreakdown').addEventListener('click', async()=>{await csvBreakdown($('#repAge').value.trim(),$('#repGender').value.trim(), $('#csvExcludeZero').checked);});
})();
</script>
</body>
</html>
